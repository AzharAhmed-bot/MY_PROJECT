<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }
        .sidebar {
            width: 250px;
            position: fixed;
            height: 100%;
            background: #343a40;
            padding: 20px;
            color: white;
        }
        .sidebar h2 { margin-bottom: 20px; }
        .sidebar button {
            display: block;
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: red;
            color: white;
            border: none;
            cursor: pointer;
        }
        .main-content {
            margin-left: 270px;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        .driver-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        .report-btn {
            background: #ffc107;
            color: black;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Manager Dashboard</h2>
        <p id="manager-name">Welcome, Manager</p>
        <button onclick="logout()">Logout</button>
    </div>

    <div class="main-content">
        <h3>All Drivers</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th><th>Name</th><th>Email</th><th>License No</th><th>Actions</th>
                </tr>
            </thead>
            <tbody id="driver-table"></tbody>
        </table>

        <h3>Driver Progress</h3>
        <table>
            <thead>
                <tr>
                    <th>Date</th><th>Vehicle</th><th>Load</th><th>Distance</th><th>Start Time</th><th>End Time</th>
                    <th>Odometer Start</th><th>Odometer End</th>
                </tr>
            </thead>
            <tbody id="trip-log"></tbody>
        </table>
    </div>

    <script>
        // Fetch and display all drivers
        function fetchDrivers() {
            fetch("http://localhost:3000/drivers")
                .then(response => response.json())
                .then(data => {
                    let table = document.getElementById("driver-table");
                    table.innerHTML = "";
                    data.forEach(driver => {
                        let row = `<tr>
                            <td>${driver.id}</td>
                            <td>${driver.name}</td>
                            <td>${driver.email}</td>
                            <td>${driver.license_number}</td>
                            <td>
                                <button class="driver-btn" onclick="viewDriverTrips(${driver.id})">View Trips</button>
                                <button class="report-btn" onclick="generateReport(${driver.id})">Generate Report</button>
                            </td>
                        </tr>`;
                        table.innerHTML += row;
                    });
                })
                .catch(error => console.error("Error fetching drivers:", error));
        }

        // Fetch and display trips for a specific driver
        function viewDriverTrips(driverId) {
            fetch(`http://localhost:3000/trips?driver_id=${driverId}`)
                .then(response => response.json())
                .then(data => {
                    let tripTable = document.getElementById("trip-log");
                    tripTable.innerHTML = "";
                    data.forEach(trip => {
                        let row = `<tr>
                            <td>${trip.date}</td>
                            <td>${trip.vehicle}</td>
                            <td>${trip.load_carried}</td>
                            <td>${trip.distance_covered}</td>
                            <td>${trip.start_time}</td>
                            <td>${trip.end_time}</td>
                            <td>${trip.odometer_start}</td>
                            <td>${trip.odometer_end}</td>
                        </tr>`;
                        tripTable.innerHTML += row;
                    });
                })
                .catch(error => console.error("Error fetching trips:", error));
        }

        // Generate and download a report for a driver
        function generateReport(driverId) {
            fetch(`http://localhost:3000/trips?driver_id=${driverId}`)
                .then(response => response.json())
                .then(data => {
                    let reportContent = "Date,Vehicle,Load,Distance,Start Time,End Time,Odometer Start,Odometer End\n";
                    data.forEach(trip => {
                        reportContent += `${trip.date},${trip.vehicle},${trip.load_carried},${trip.distance_covered},${trip.start_time},${trip.end_time},${trip.odometer_start},${trip.odometer_end}\n`;
                    });

                    // Create a downloadable file
                    let blob = new Blob([reportContent], { type: "text/csv" });
                    let link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `driver_${driverId}_report.csv`;
                    link.click();
                })
                .catch(error => console.error("Error generating report:", error));
        }

        // Logout function
        function logout() {
            localStorage.removeItem("manager");
            window.location.href = "login.html";
        }

        // Display manager name
        const manager = JSON.parse(localStorage.getItem("manager"));
        if (manager) {
            document.getElementById("manager-name").innerText = `Welcome, ${manager.name}`;
        } else {
            window.location.href = "login.html";
        }

        fetchDrivers();
    </script>

</body>
</html>
